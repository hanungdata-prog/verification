<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Verification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 480px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #6a11cb, #2575fc);
        }

        .logo {
            margin-bottom: 24px;
        }

        .logo i {
            font-size: 48px;
            color: #5865F2;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h1 {
            color: #2c2f33;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .subtitle {
            color: #72767d;
            font-size: 16px;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .user-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .user-info h3 {
            color: #36393f;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .user-info p {
            margin: 8px 0;
            color: #4f545c;
            font-size: 14px;
        }

        .user-info strong {
            color: #2c2f33;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #36393f;
            font-size: 14px;
        }

        input[type="text"], input[type="hidden"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e3e5e8;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #5865F2;
            box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2);
        }

        .captcha-container {
            margin: 20px 0;
            text-align: center;
        }

        button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 16px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(106, 17, 203, 0.3);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(106, 17, 203, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            margin: 20px 0;
            text-align: center;
            color: #72767d;
        }

        .loading:after {
            content: " .";
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: " ."; }
            40% { content: " . ."; }
            60%, 100% { content: " . . ."; }
        }

        .message {
            margin: 20px 0;
            padding: 14px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            text-align: center;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .privacy-link {
            margin-top: 24px;
            font-size: 13px;
            color: #72767d;
        }

        .privacy-link a {
            color: #5865F2;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .privacy-link a:hover {
            color: #4752c4;
            text-decoration: underline;
        }

        .account-switch {
            margin-top: 20px;
            font-size: 14px;
        }

        .account-switch a {
            color: #5865F2;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .account-switch a:hover {
            color: #4752c4;
            text-decoration: underline;
        }

        @media (max-width: 480px) {
            .container {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <i class="fab fa-discord"></i>
        </div>
        
        <h1>Verify Your Account</h1>
        <p class="subtitle">Complete verification to access the community</p>

        <div class="user-info">
            <h3><i class="fab fa-discord"></i> Verified Discord Account</h3>
            <p><strong>ID:</strong> <span id="userId">Loading...</span></p>
            <p><strong>Username:</strong> <span id="userName">Loading...</span></p>
        </div>

        <!-- Hidden fields for Discord ID and username -->
        <input type="hidden" id="discordId" name="discordId" value="">
        <input type="hidden" id="discordUsername" name="discordUsername" value="">
        
        <form id="verificationForm">
            <!-- Hidden fields for Discord ID and username -->
            <input type="hidden" id="discordId" name="discordId" value="">
            <input type="hidden" id="discordUsername" name="discordUsername" value="">
            
            <div class="form-group">
                <div class="captcha-container" id="captchaContainer">
                    <label>Security Verification</label>
                    <div id="captchaWidget" style="margin: 15px 0;"></div>
                </div>
            </div>
            
            <button type="submit" id="submitBtn">Verify & Continue</button>
        </form>
        
        <div class="loading" id="loading">Verifying your account...</div>
        <div class="message" id="message"></div>
        
        <div class="account-switch">
            <a href="/discord/login"><i class="fas fa-sync-alt"></i> Switch Discord Account</a>
        </div>
        
        <div class="privacy-link">
            <a href="/privacy"><i class="fas fa-user-shield"></i> Privacy Policy</a>
        </div>
    </div>

    <script>
        // Configuration - hCaptcha only
        const HCAPTCHA_SITE_KEY = "f9b8d3ba-9142-42c8-9ee6-57f23258f83a"; // Your hCaptcha site key

        // Function to extract URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to populate Discord user data
        function populateDiscordData() {
            const discordId = getUrlParameter('discord_id');
            const discordUsername = getUrlParameter('discord_username');

            console.log('Discord ID:', discordId);
            console.log('Discord Username:', discordUsername);

            if (discordId && discordUsername) {
                // Update display elements
                document.getElementById('userId').textContent = discordId;
                document.getElementById('userName').textContent = discordUsername;

                // Update all hidden fields with Discord ID
                const discordIdFields = document.querySelectorAll('#discordId');
                discordIdFields.forEach(field => {
                    field.value = discordId;
                });

                // Update all hidden fields with Discord username
                const discordUsernameFields = document.querySelectorAll('#discordUsername');
                discordUsernameFields.forEach(field => {
                    field.value = discordUsername;
                });
            } else {
                document.getElementById('userId').textContent = 'Not available';
                document.getElementById('userName').textContent = 'Not available';
                showMessage('Discord user information not found. Please try logging in again.', 'error');
            }
        }

        // DOM elements
        const form = document.getElementById('verificationForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');
        const captchaWidget = document.getElementById('captchaWidget');
        let currentToken = '';
        
        // Load hCaptcha automatically when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Populate Discord user data from URL parameters
            populateDiscordData();

            if (HCAPTCHA_SITE_KEY) {
                loadHcaptcha();
            } else {
                captchaWidget.innerHTML = '<p class="error">Security verification not configured. Please contact the administrator.</p>';
            }
        });
        
        // Load hCaptcha
        function loadHcaptcha() {
            const siteKey = HCAPTCHA_SITE_KEY;
            if (!siteKey) {
                captchaWidget.innerHTML = '<p class="error">hCaptcha site key not configured. Please contact the administrator.</p>';
                return;
            }
            
            // Add hCaptcha script if not already loaded
            if (!window.hcaptcha && !document.getElementById('hcaptcha-script')) {
                const script = document.createElement('script');
                script.id = 'hcaptcha-script';
                script.src = 'https://js.hcaptcha.com/1/api.js';
                document.head.appendChild(script);
            }
            
            // Add hCaptcha widget container
            captchaWidget.innerHTML = `<div class="h-captcha" data-sitekey="${siteKey}" data-callback="onHcaptchaSuccess"></div>`;
        }
        
        // Event handler for form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values (from hidden fields)
            const discordId = document.getElementById('discordId').value;
            const discordUsername = document.getElementById('discordUsername').value;
            
            // Check for CAPTCHA token
            if (!currentToken) {
                showMessage('Please complete the security verification', 'error');
                return;
            }
            
            // Disable submit button and show loading
            submitBtn.disabled = true;
            loading.style.display = 'block';
            message.style.display = 'none';
            
            try {
                // Prepare request data
                const requestData = {
                    discord_id: discordId,
                    discord_username: discordUsername,
                    captcha_token: currentToken,
                    metadata: {
                        timestamp: new Date().toISOString(),
                        source: 'auto_detected_discord_oauth',
                        captcha_provider: 'hcaptcha'
                    }
                };
                
                // Send verification request to serverless function
                const response = await fetch('/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('Verification response:', result);
                    showMessage(result.message || 'Verification successful! Redirecting to Discord...', 'success');
                    // Redirect to Discord after success
                    setTimeout(() => {
                        window.location.href = result.redirect_url || 'https://discord.gg/UNpRpJMt';
                    }, 2000);
                } else {
                    showMessage(result.message || 'Verification failed', 'error');
                }
            } catch (error) {
                console.error('Verification error:', error);
                if (error.message.includes('Unexpected token')) {
                    showMessage('Server error: Invalid response format. The /verify endpoint may not be configured correctly.', 'error');
                } else {
                    showMessage(`Verification error: ${error.message}`, 'error');
                }
            } finally {
                // Re-enable submit button and hide loading
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        });
        
        // Helper function to show messages
        function showMessage(text, type) {
            message.textContent = text;
            message.className = 'message ' + type;
            message.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    message.style.display = 'none';
                }, 5000);
            }
        }
        
        // hCaptcha callback function
        function onHcaptchaSuccess(token) {
            currentToken = token;
            console.log('hCaptcha verified:', token);
        }
    </script>
</body>
</html>