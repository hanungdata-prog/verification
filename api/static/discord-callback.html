<!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticating with Discord - AuthGateway</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
    <script src="theme.js"></script>

    <style>
        body {
            background: var(--color-bg-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-4);
            overflow: hidden;
        }

        .callback-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            max-width: 480px;
            width: 100%;
            box-shadow: var(--shadow-md);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .callback-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: var(--gradient-primary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .logo {
            width: 64px; height: 64px;
            margin: 0 auto var(--space-4);
            background: var(--color-accent);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-2xl);
            color: white;
        }

        h1 {
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-semibold);
        }

        .message {
            color: var(--color-text-secondary);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            margin-bottom: var(--space-6);
        }

        .loader-container {
            margin: var(--space-6) 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-4);
        }

        .loader {
            width: 48px; height: 48px;
            position: relative;
        }

        .loader-discord {
            width: 100%; height: 100%;
            border: 3px solid var(--color-border-primary);
            border-top: 3px solid var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin: var(--space-4) 0;
            text-align: left;
            max-width: 280px;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--color-text-muted);
            font-size: var(--font-size-sm);
        }

        .error-container {
            margin-top: var(--space-6);
            padding: var(--space-4);
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--color-error);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .retry-btn {
            margin-top: var(--space-3);
            background: var(--color-accent);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="callback-card">
        <div class="logo"><i class="fas fa-shield-halved"></i></div>
        <h1>Authenticating...</h1>
        <p class="message">We're processing your Discord authentication securely.</p>

        <div class="loader-container">
            <div class="loader"><div class="loader-discord"></div></div>
        </div>

        <div class="loading-steps" id="loadingSteps">
            <div class="loading-step active" id="step1"><i class="fas fa-circle-notch fa-spin"></i> Connecting to Discord</div>
            <div class="loading-step pending" id="step2"><i class="far fa-circle"></i> Verifying credentials</div>
            <div class="loading-step pending" id="step3"><i class="far fa-circle"></i> Processing authentication</div>
            <div class="loading-step pending" id="step4"><i class="far fa-circle"></i> Granting access</div>
        </div>

        <div class="error-container" id="errorContainer" style="display: none;">
            <div class="error-message" id="errorMessage"></div>
            <button class="retry-btn" onclick="retryAuthentication()">Try Again</button>
        </div>
    </div>

    <script>
        let currentStep = 1, retryCount = 0, maxRetries = 3;

        function updateLoadingStep(step, status) {
            const el = document.getElementById(`step${step}`);
            el.className = `loading-step ${status}`;
            const icon = el.querySelector('i');
            const icons = { pending: 'far fa-circle', active: 'fas fa-circle-notch fa-spin', completed: 'fas fa-check-circle', error: 'fas fa-times-circle' };
            icon.className = icons[status];
        }

        async function handleDiscordCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (!code) { showError('No authorization code found.'); return; }

            try {
                updateLoadingStep(1, 'active'); await delay(500);
                updateLoadingStep(1, 'completed'); updateLoadingStep(2, 'active'); await delay(500);

                const res = await fetch('/api/discord/callback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                updateLoadingStep(2, 'completed'); updateLoadingStep(3, 'active'); await delay(500);

                if (res.ok) {
                    const data = await res.json();
                    updateLoadingStep(3, 'completed'); updateLoadingStep(4, 'active'); await delay(500);
                    window.location.href = data.redirect_url || '/verify-auto.html';
                } else {
                    throw new Error(`Server error: ${res.status}`);
                }
            } catch (err) {
                updateLoadingStep(currentStep, 'error');
                if (retryCount < maxRetries) {
                    retryCount++;
                    showError(`Retrying... (${retryCount}/${maxRetries})`, true);
                    setTimeout(handleDiscordCallback, 2000);
                } else {
                    showError('Authentication failed. Please try again.');
                }
            }
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
        function showError(msg, isRetry = false) {
            document.querySelector('.loader-container').style.display = 'none';
            document.getElementById('loadingSteps').style.display = 'none';
            const container = document.getElementById('errorContainer');
            document.getElementById('errorMessage').textContent = msg;
            container.style.display = 'block';
        }
        function retryAuthentication() {
            retryCount = 0;
            document.getElementById('errorContainer').style.display = 'none';
            handleDiscordCallback();
        }

        window.addEventListener('load', () => setTimeout(handleDiscordCallback, 300));
    </script>
</body>
</html>